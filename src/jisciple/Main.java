package jisciple;

import java.io.DataOutputStream;
import java.io.IOException;
import java.io.InputStream;
import java.net.Socket;
import java.util.Timer;
import java.util.TimerTask;

import jisciple.iso8583.config.IsoConfigConverter;
import jisciple.iso8583.config.MensagemIsoConfig;
import jisciple.iso8583.config.iso.OldIsoConfig;
import jisciple.iso8583.config.iso.OldIsoConfigStructure;
import jisciple.iso8583.config.sizeheader.SizeHeaderConfig;
import jisciple.iso8583.config.sizeheader.TcpConfig;
import jisciple.iso8583.util.Util;
import jisciple.iso8583.util.YamlReader;
import jisciple.server.RebatedorServer;

public class Main {

	public static final int PORT = 6666;

	public static void main(String[] args) {

		MensagemIsoConfig isoConfig;
		SizeHeaderConfig headerConfig;
		String teste1 = "030549534f303236303030303130303230304232333843343831323845333830314130303030303030303130303030303139303030303330303030303030303030333030303132373134313431343039343633363039313435363031323730313237343133313035313030313131303030303030303039303337343535393836303033393737343131363d323031303230313138343232363530303030303030303032373030303030313530303044463034342020202020202020303120203031313931383734352020454b544543202020202020202020202020202020202041524d454e4941202020202020363320434f30333630303030303030303030303030303030303030303030303030303030303030303030303030323730313139313837343520202020202020202020303030303030303031373030313630303930544553322b30303030303030303139202020205445533230303030303030303030303335382620303030303530303335382120423230303135382037464639303030303830303838303030383030303734463335444545433533354243344230303030303030303033303030303030303030303030303033433030303035373037363938363230303132373030333239334343443130303037303630313041303341304238303130303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030302120423330303038302043463030333036373130323745304530433030303030303030303030303030303232303030303145303330303030303741303030303030303033313031303030303030303030303030303030303030302120423430303032302030353135313020203145303330303135303930202120514330303034382030303030303030303030303030534d303030303030303030303030303030303030303030303030303030303030303030313130303030303030303030303030392020202020202020203031322020423234204232342031203033343046423430303030303030303003";
		// String teste2 =
		// "3034393901007238478228C08232164122943420956225000000000000000100050509074600000609074605055999005100010052000131274122943420956225D2411221486F3030303030303030303030353031303639383836303030303834303030323130303035048402054F07A00000000310109F120B564953412044454249544F500B564953412044454249544F5F3401019F3403010302950580800080009F2701809F26087317AC6237CE5EC49B0268009F3901515F24032411305F2A02048482021C008407A00000000310109A032105059C01009F02060000000001009F03060000000000009F0607A00000000310109F0802009A9F0902008D9F100706010A03A480009F1A0204849F1E0830333932313635389F3303E0B0C89F3501229F360201459F370471C88B399F4104000000079F5301520931313535302020202045017500483134592020202020202020202020202020202020202020203030303030303030303030303030303030303030303030300060333631000000000000000000003132333435000000000000000000000000000000000000000000000000000000000000000000000000000000000000002336393031310B5643494E440000000000005443523031340028534458433030313254433031353430313131313130303030303030300002564900024556";

		final byte[] dump = Util.asciiToBytes(teste1.getBytes());

		System.out.println(new String(dump));

		try {

			OldIsoConfig oldConfig = YamlReader.readConfig("config/iso.yml", OldIsoConfigStructure.class).getIso();
			isoConfig = IsoConfigConverter.convert(oldConfig);

			headerConfig = YamlReader.readConfig("config/size-header.yml", TcpConfig.class).getSizeHeader();

//			MensagemIso iso = MensagemIsoParser.parseIso(dump, isoConfig, headerConfig);
//			System.out.println(iso.prettyPrint());

			RebatedorServer server = new RebatedorServer(isoConfig, headerConfig, PORT); // cria numa thread separada
			server.start();

			TimerTask t = new TimerTask() {
				@Override
				public void run() {
					try {
						Socket socket = new Socket("127.0.0.1", PORT);
						InputStream is = socket.getInputStream();
						DataOutputStream os = new DataOutputStream(socket.getOutputStream());
						os.write(dump);
						os.flush();
						os.close();
						is.close();
						socket.close();

					} catch (Exception e) {
						e.printStackTrace();
					}
				}
			};

			new Timer().schedule(t, 2000);

		} catch (IOException e) {
			e.printStackTrace();
		}

	}

}
